<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Historial de Facturación - FlorecillaService</title>
  <link rel="stylesheet" th:href="@{/css/styles.css}">
  <script th:src="@{/js/main.js}"></script>
</head>

<body>

<header>
  <img th:src="@{/imagen/florLogo.png}" alt="Logo FlorecillaService">
  <h1><span class="logo-text">FlorecillaService</span> / Clientes / Historial Facturación</h1>
</header>

<main>

  <a th:href="@{/clientes/{id}(id=${cliente.idCuenta})}" class="btn-atras">
    <img th:src="@{/imagen/botonAccion-Atras.png}" alt="Atrás" class="icono-img-atras">
    Volver al detalle del cliente
  </a>

  <div class="form-container">
    <div class="form-section-titles">
      <h3>Información de cliente</h3>
    </div>
    <div class="form-grid" style="grid-template-columns: repeat(4, 1fr);">
      <div class="form-group">
        <label>Nombre Completo</label>
        <input type="text" th:value="${cliente.nombre} + ' ' + ${cliente.apellido}" readonly>
      </div>
      <div class="form-group">
        <label>Documento</label>
        <input type="text" th:value="${cliente.tipoDocumento} + ': ' + ${cliente.numeroDocumento}" readonly>
      </div>
      <div class="form-group">
        <label>Condición Fiscal</label>
        <input type="text" th:value="${cliente.condIVA}" readonly>
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="text" th:value="${cliente.mail}" readonly>
      </div>
    </div>
  </div>

  <br>

  <div class="table-container">
    <h2 class="table-title">Historial de facturas</h2>
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th>Nro. Factura</th>
          <th>Periodo</th>
          <th>Emisión</th>
          <th>Vencimiento</th>
          <th>Monto Total</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="factura : ${facturas}">

          <td th:text="${factura.idFactura}"></td>

          <td th:switch="${factura.periodo}">
            <span th:case="1">Enero</span>
            <span th:case="2">Febrero</span>
            <span th:case="3">Marzo</span>
            <span th:case="4">Abril</span>
            <span th:case="5">Mayo</span>
            <span th:case="6">Junio</span>
            <span th:case="7">Julio</span>
            <span th:case="8">Agosto</span>
            <span th:case="9">Septiembre</span>
            <span th:case="10">Octubre</span>
            <span th:case="11">Noviembre</span>
            <span th:case="12">Diciembre</span>
            <span th:case="*" th:text="${factura.periodo}"></span>
          </td>

          <td th:text="${factura.fecha}"></td> <td th:text="${factura.vencimiento}"></td>

          <td th:text="'$ ' + ${factura.precioTotal}"></td>

          <td>
              <span th:if="${factura.estado.name() == 'VIGENTE'}"
                    style="color: #ef6c00; font-weight: bold; background: #fff3e0; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                VIGENTE
              </span>

            <span th:if="${factura.estado.name() == 'VENCIDA'}"
                  style="color: #c62828; font-weight: bold; background: #ffebee; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                VENCIDA
                            </span>

            <span th:if="${factura.estado.name() == 'PAGADA'}"
                  style="color: #2e7d32; font-weight: bold; background: #e8f5e9; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                PAGADA
                            </span>

            <span th:if="${factura.estado.name() == 'ANULADA'}"
                  style="color: #616161; font-weight: bold; background: #f5f5f5; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                ANULADA
                            </span>

            <span th:if="${factura.estado.name() == 'PARCIAL'}"
                  style="color: #1565c0; font-weight: bold; background: #e3f2fd; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                PARCIAL
                            </span>
          </td>

          <td>
    <div>
        <!-- Botón PAGAR -->
        <button th:if="${factura.estado.name() == 'VIGENTE' or factura.estado.name() == 'VENCIDA' or factura.estado.name() == 'PARCIAL'}"
                type="button" class="action-link-success action-link-button"
                th:onclick="'window.location.href=\'/administrar-pagos?clienteId=' + ${cliente.idCuenta} + '\''">            Pagar
        </button>

        <!-- Botón ANULAR -->
        <form th:if="${factura.estado.name() == 'VIGENTE'}" 
              th:action="@{/api/facturacion/anular/{id}(id=${factura.idFactura})}" 
              method="post" style="display: inline;">
            
            <input type="hidden" name="motivo" />
            
            <button type="button" class="action-link-danger action-link-button"
                    onclick="var motivo = prompt('Ingrese el motivo de la anulación:'); 
                             if (motivo != null && motivo.trim() !== '') { 
                                 this.form.motivo.value = motivo; 
                                 this.form.submit(); 
                             }">
                Anular
            </button>
        </form>

        <!-- AGREGO ESTE BOTON PARA VER LAS FACTURAS. es piloto no hay nada implementado-->
        <button type="button" class="action-link action-link-button"
                th:onclick="'vistaFactura(' + ${factura.idFactura} + ')'">
            Ver
        </button>

       </div>
</td>
        </tr>

        <tr th:if="${facturas == null or facturas.isEmpty()}" class="empty-row">
          <td colspan="7">Este cliente no posee historial de facturación.</td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>


    <br>

    <!-- TABLA 2: PAGOS REALIZADOS (COMPROBANTES) -->
    <div class="table-container">
        <h2 class="table-title" style="background-color: rgba(46, 125, 50, 0.1); color: #2e7d32;">
            <i class="fas fa-receipt"></i> Pagos Realizados y Comprobantes
        </h2>
        <div class="table-wrapper">
            <table>
                <thead>
                <tr>
                    <th>Nro. Pago</th>
                    <th>Fecha de Pago</th>
                    <th>Método</th>
                    <th>Factura(s) Asociada(s)</th>
                    <th>Monto Pagado</th>
                    <th style="text-align: center;">Comprobante</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="pago : ${pagos}">
                    <td th:text="'#' + ${pago.idPago}"></td>
                    <td th:text="${#temporals.format(pago.fechaPago, 'dd/MM/yyyy HH:mm')}"></td>
                    <td th:text="${pago.metodoPago}"></td>

                    <!-- Lógica para mostrar ID de facturas si la relación existe -->
                    <td>
                        <span th:if="${pago.factura != null}" th:text="'Factura #' + ${pago.factura.idFactura}"></span>
                        <span th:if="${pago.factura == null}">Pago General</span>
                    </td>

                    <td th:text="'$ ' + ${#numbers.formatDecimal(pago.importe, 1, 2)}" style="font-weight: bold; color: #2e7d32;"></td>

                    <td style="text-align: center;">
                        <button type="button" class="btn btn-primary" style="padding: 4px 12px; font-size: 12px;"
                                th:data-id="${pago.idPago}"
                                th:data-fecha="${#temporals.format(pago.fechaPago, 'dd/MM/yyyy HH:mm')}"
                                th:data-monto="${pago.importe}"
                                th:data-metodo="${pago.metodoPago}"
                                th:data-responsable="${pago.empleadoResponsable}"
                                th:data-factura="${pago.factura != null ? pago.factura.idFactura : 'N/A'}"
                                onclick="abrirModalRecibo(this)">
                            <i class="fas fa-eye"></i> Ver Recibo
                        </button>
                    </td>
                </tr>
                <tr th:if="${pagos == null or pagos.isEmpty()}" class="empty-row">
                    <td colspan="6">No se han registrado pagos para este cliente.</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

</main>

</body>
</html>