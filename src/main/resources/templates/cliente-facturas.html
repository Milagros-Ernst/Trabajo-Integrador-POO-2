<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Historial de Facturación - FlorecillaService</title>
  <link rel="stylesheet" th:href="@{/css/styles.css}">
  <script th:src="@{/js/main.js}"></script>
</head>

<body>

<header>
  <img th:src="@{/imagen/florLogo.png}" alt="Logo FlorecillaService">
  <h1><span class="logo-text">FlorecillaService</span> / Clientes / Historial de Facturación</h1>
</header>

<main>
    <a th:href="@{${cliente != null ? '/clientes/gestion/' + cliente.idCuenta : '/clientes'}}" class="btn-atras">
        <img th:src="@{/imagen/botonAccion-Atras.png}" alt="Atrás" class="icono-img-atras">
        <span th:text="${cliente != null} ? 'Volver al detalle del cliente' : 'Volver al Inicio'"></span>
    </a>
    <!-- nueva implementacion, el combo de cliente -->
    <div class="form-container">
        <div class="form-section-titles">
            <h3>Selección de Cliente</h3>
        </div>
        <form th:action="@{/clientes/facturacion/seleccionar}" method="get" id="form-seleccion-cliente">
            <div class="form-group">
                <label for="select-cliente-historial">Seleccione un cliente para ver su historial:</label>
                <select id="select-cliente-historial" name="clienteId" onchange="this.form.submit()" required>
                    <option value="" disabled selected>-- Buscar Cliente --</option>
                    <option th:each="cli : ${clientes}"
                            th:value="${cli.idCuenta}"
                            th:text="${cli.nombre} + ' ' + ${cli.apellido} + ' (DNI: ' + ${cli.numeroDocumento} + ')'"
                            th:selected="${cliente != null and cliente.idCuenta == cli.idCuenta}">
                    </option>
                </select>
            </div>
        </form>
    </div>

    <br>

    <div th:if="${cliente != null}">

        <div class="form-container">
        <div class="form-section-titles">
            <h3>Información de cliente</h3>
        </div>
        <div class="form-grid" style="grid-template-columns: repeat(4, 1fr);">
            <div class="form-group">
                <label>Nombre Completo</label>
                <input type="text" th:value="${cliente.nombre} + ' ' + ${cliente.apellido}" readonly>
            </div>
            <div class="form-group">
                <label>Documento</label>
                <input type="text" th:value="${cliente.tipoDocumento} + ': ' + ${cliente.numeroDocumento}" readonly>
            </div>
            <div class="form-group">
                <label>Condición Fiscal</label>
                <input type="text" th:value="${cliente.condIVA}" readonly>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="text" th:value="${cliente.mail}" readonly>
            </div>
            <div class="btn-wrapper-right" style="margin-top: 15px; grid-column: span 4; text-align: right;">
                <a th:href="@{/administrar-pagos(clienteId=${cliente.idCuenta})}" class="btn-verfacturas">
                    Ir a gestionar pagos
                </a>
            </div>
        </div>
    </div>


        <!-- fin de nueva implementacion -->

  <br>

  <div class="table-container">
    <h2 class="table-title">Historial de facturas</h2>
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th>Nro. Factura</th>
          <th>Periodo</th>
          <th>Emisión</th>
          <th>Vencimiento</th>
          <th>Monto Total</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="factura : ${facturas}">

          <td th:text="${factura.idFactura}"></td>

          <td th:switch="${factura.periodo}">
            <span th:case="1">Enero</span>
            <span th:case="2">Febrero</span>
            <span th:case="3">Marzo</span>
            <span th:case="4">Abril</span>
            <span th:case="5">Mayo</span>
            <span th:case="6">Junio</span>
            <span th:case="7">Julio</span>
            <span th:case="8">Agosto</span>
            <span th:case="9">Septiembre</span>
            <span th:case="10">Octubre</span>
            <span th:case="11">Noviembre</span>
            <span th:case="12">Diciembre</span>
            <span th:case="*" th:text="${factura.periodo}"></span>
          </td>

          <td th:text="${factura.fecha}"></td> <td th:text="${factura.vencimiento}"></td>

          <td th:text="'$ ' + ${factura.precioTotal}"></td>

          <td>
              <span th:if="${factura.estado.name() == 'VIGENTE'}"
                    style="color: #ef6c00; font-weight: bold; background: #fff3e0; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                VIGENTE
              </span>

            <span th:if="${factura.estado.name() == 'VENCIDA'}"
                  style="color: #c62828; font-weight: bold; background: #ffebee; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                VENCIDA
                            </span>

            <span th:if="${factura.estado.name() == 'PAGADA'}"
                  style="color: #2e7d32; font-weight: bold; background: #e8f5e9; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                PAGADA
                            </span>

            <span th:if="${factura.estado.name() == 'ANULADA'}"
                  style="color: #616161; font-weight: bold; background: #f5f5f5; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                ANULADA
                            </span>

            <span th:if="${factura.estado.name() == 'PARCIAL'}"
                  style="color: #1565c0; font-weight: bold; background: #e3f2fd; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                PARCIAL
                            </span>
          </td>

          <td>
    <div>
        <!-- Botón PAGAR -->
        <a th:if="${factura.estado.name() == 'VIGENTE' or factura.estado.name() == 'VENCIDA' or factura.estado.name() == 'PARCIAL'}"
           th:href="@{/administrar-pagos(clienteId=${cliente.idCuenta})}"
           class="action-link-success action-link-button"
           style="text-decoration: none; cursor: pointer;">
            Pagar
        </a>

        <!-- Botón ANULAR -->
        <form th:if="${factura.estado.name() == 'VIGENTE'}" 
              th:action="@{/facturacion/anular/{id}(id=${factura.idFactura})}"
              method="post" style="display: inline;">
            
            <input type="hidden" name="motivo" />
            
            <button type="button" class="action-link-danger action-link-button"
                    onclick="var motivo = prompt('Ingrese el motivo de la anulación:'); 
                             if (motivo != null && motivo.trim() !== '') { 
                                 this.form.motivo.value = motivo; 
                                 this.form.submit(); 
                             }">
                Anular
            </button>
        </form>

        <!-- lleva a la factura normal -->
        <a th:if="${factura.estado.name() != 'ANULADA'}"
           th:href="@{/clientes/facturacion/ver/{id}(id=${factura.idFactura})}"
           class="action-link action-link-button"
           style="text-decoration: none; color: inherit;">
            Ver
        </a>

        <!-- lleva a la nota de crédito -->
        <a th:if="${factura.estado.name() == 'ANULADA'}"
           th:href="@{/clientes/facturacion/nota-credito/{id}(id=${factura.idFactura})}"
           class="action-link action-link-button"
           style="text-decoration: none; cursor: pointer;">
            Ver Nota
        </a>


       </div>
</td>
        </tr>

        <tr th:if="${facturas == null or facturas.isEmpty()}" class="empty-row">
          <td colspan="7">Este cliente no posee historial de facturación.</td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>

        <div class="payment-footer"
             style="display: flex; justify-content: flex-end; align-items: center; gap: 20px; margin-top: 20px; background-color: #fff; padding: 8px 20px; border-radius: 8px; border: 1px solid #ddd; box-shadow: 0 -2px 10px rgba(0,0,0,0.05);">

            <div style="text-align: right;">
                <span style="display: block; font-size: 12px; color: #666; line-height: 1.2;">Deuda Total Pendiente:</span>
                <span th:text="'$ ' + ${#numbers.formatDecimal(totalDeuda, 1, 2)}"
                      style="font-size: 18px; font-weight: bold; color: #c62828; line-height: 1.2;">
            $ 0.00
        </span>
            </div>

            <a th:href="@{/administrar-pagos(clienteId=${cliente.idCuenta})}"
               class="btn btn-primary"
               style="background-color: #2e7d32; border: none; padding: 8px 20px; font-size: 14px; color: white; border-radius: 5px; text-decoration: none; display: inline-block;">
                <i class="fas fa-money-bill-wave"></i> PAGAR AHORA
            </a>

        </div>

    <br>

    <!-- TABLA 2: PAGOS REALIZADOS (COMPROBANTES) -->
    <div class="table-container">
        <h2 class="table-title" style="background-color: rgba(46, 125, 50, 0.1); color: #2e7d32;">
            <i class="fas fa-receipt"></i> Pagos Realizados y Comprobantes
        </h2>
        <div class="table-wrapper">
            <table>
                <thead>
                <tr>
                    <th>Nro. Pago</th>
                    <th>Fecha de Pago</th>
                    <th>Método</th>
                    <th>Factura(s) Asociada(s)</th>
                    <th>Monto Pagado</th>
                    <th style="text-align: center;">Comprobante</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="pago : ${pagos}">
                    <td th:text="'#' + ${pago.idPago}"></td>
                    <td th:text="${#temporals.format(pago.fechaPago, 'dd/MM/yyyy')}"></td>
                    <td th:text="${pago.metodoPago}"></td>

                    <!-- Lógica para mostrar ID de facturas si la relación existe -->
                    <td>
                        <span th:if="${pago.factura != null}" th:text="'Factura #' + ${pago.factura.idFactura}"></span>
                        <span th:if="${pago.factura == null}">Pago General</span>
                    </td>

                    <td th:text="'$ ' + ${#numbers.formatDecimal(pago.importe, 1, 2)}" style="font-weight: bold; color: #2e7d32;"></td>

                    <td style="text-align: center;">
                        <button type="button" class="btn btn-primary" style="padding: 4px 12px; font-size: 12px;"
                                th:data-id="${pago.idPago}"
                                th:data-fecha="${#temporals.format(pago.fechaPago, 'dd/MM/yyyy')}"
                                th:data-monto="${pago.importe}"
                                th:data-metodo="${pago.metodoPago}"
                                th:data-responsable="${pago.empleadoResponsable}"
                                th:data-factura="${pago.factura != null ? pago.factura.idFactura : 'N/A'}"
                                onclick="abrirModalRecibo(this)">
                            <i class="fas fa-eye"></i> Ver Recibo
                        </button>
                    </td>
                </tr>
                <tr th:if="${pagos == null or pagos.isEmpty()}" class="empty-row">
                    <td colspan="6">No se han registrado pagos para este cliente.</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    </div>

</main>

</body>
</html>